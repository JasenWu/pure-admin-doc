---
title: 打包和部署
date: 2022-11-07
permalink: /pages/build/
---

### 本地环境打包预览

```
pnpm preview:build
```

### 预发布打包

[.env.staging](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/.env.staging) 文件为预发布打包前的配置文件，[预发布](https://cn.vitejs.dev/guide/env-and-mode.html#modes) <Badge text="vite文档"/>

```
pnpm build:staging
```

### 正式环境打包

[.env.production](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/.env.production) 文件为正式环境打包前的配置文件

```
pnpm build
```

### 打包分析

```
pnpm report
```

![report](~@alias/img/guide/report.jpg)

### 项目文件、语言分析

分析项目采用了哪些语言以及代码量

```
pnpm cloc
```

![image-cloc](~@alias/img/guide/cloc.jpg)

:::tip 打包优化
点击查看更多 [打包优化](/pages/buildgood/)
:::

## 部署

### `nginx`

在 [http 请求篇](/pages/request/#什么是跨域)，平台主推使用 `nginx` 部署，因为可以满足绝大多数场景，下面我们讲一下如何配置

#### 项目打包

平台提供了全局打包路径 [VITE_PUBLIC_PATH](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/.env.production#L2) ，默认 `/`，可根据需求自行修改。比如平台的预览地址是 `https://yiming_chang.gitee.io/vue-pure-admin/#/login`，可以看到根目录 `https://yiming_chang.gitee.io` 后面又跟了个 `/vue-pure-admin/` 子目录，那么我们打包时就应该把 `VITE_PUBLIC_PATH` 改成 `/vue-pure-admin/`，然后执行 `pnpm build` 就行，打包完后观察项目根目录会多出个 `dist` 目录，如下图

![dist-small](~@alias/img/build/dist-small.jpg)

#### `nginx` 配置

拿 `mac` 举例，配置都一样，可能您们对应的目录不一样，根据实际情况修改即可

① 上面打包好后，来到 `/usr/local/var/www` 目录下，将打包后 `dist` 文件里的静态资源都放进去即可，如下图

![dist](~@alias/img/build/dist.jpg)

② 比如我们在 `vite.config.ts` 配置了两个后端地址，如下

```ts
proxy: {
  // 第一个代理后端地址
  "/api": {
    target: "http://127.0.0.1:3000",
    changeOrigin: true,
    rewrite: path => path.replace(/^\/api/, "")
  },
  // 第二个代理后端地址
  "/otherApi": {
    target: "http://127.0.0.1:3290",
    changeOrigin: true,
    rewrite: path => path.replace(/^\/otherApi/, "")
  },
}
```

来到 `/usr/local/etc/nginx/nginx.conf` 这个 `nginx` 的配置文件，修改成如下配置即可

nginx.config

```
location / {
    root   html;
    index  index.html index.htm;
    # 用于配合前端路由为h5模式使用，防止刷新404 https://router.vuejs.org/zh/guide/essentials/history-mode.html#nginx
    try_files $uri $uri/ /index.html;
}

# 第一个代理后端地址（vite.config.ts里叫 /api，这里也要保持一致）
location /api {
    rewrite  ^.+api/?(.*)$ /$1 break;
    # 这里填写后端地址
    proxy_pass  http://127.0.0.1:3000;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 第二个代理后端地址（vite.config.ts里叫 /otherApi，这里也要保持一致）
location /otherApi {
    rewrite  ^.+otherApi/?(.*)$ /$1 break;
    # 这里填写后端地址
    proxy_pass  http://127.0.0.1:3290;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

一份干净无注释的 `nginx.config` 配置

::: details

```
location / {
    root   html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
}

location /api {
    rewrite  ^.+api/?(.*)$ /$1 break;
    proxy_pass  http://127.0.0.1:3000;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

location /otherApi {
    rewrite  ^.+otherApi/?(.*)$ /$1 break;
    proxy_pass  http://127.0.0.1:3290;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

:::

![nginx-config](~@alias/img/build/nginx-config.jpg)

:::tip 上面的配置是平台的 VITE_PUBLIC_PATH = / 情况，也就是只有跟目录的情况。下面的配置为有子目录情况，比如子目录叫 `vue-pure-admin`

① 来到 [.env.production](https://gitee.com/yiming_chang/pure-admin-thin/blob/main/.env.production#L2)，将 VITE_PUBLIC_PATH 等于 `/vue-pure-admin`，如下

```
# 线上环境项目打包路径
VITE_PUBLIC_PATH = /vue-pure-admin/
```

② 配置 `nginx.config` 如下，可以看到多了个 `location /vue-pure-admin/` 配置

nginx.config

::: details

```
location / {
    root   html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
}

location /vue-pure-admin/ {
    root   html;
    index  index.html index.htm;
    try_files $uri $uri/ /vue-pure-admin/index.html;
}

location /api {
    rewrite  ^.+api/?(.*)$ /$1 break;
    proxy_pass  http://127.0.0.1:3000;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

location /otherApi {
    rewrite  ^.+otherApi/?(.*)$ /$1 break;
    proxy_pass  http://127.0.0.1:3290;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

:::

#### `nginx` 常用命令

##### 启动 `nginx`

```
sudo nginx
```

##### 重启 `nginx`

```
sudo nginx -s reload
```

##### 停止运行 `nginx`

```
sudo nginx -s stop
```

##### 判断 `nginx.config` 配置文件语法是否正确

常用于当您配置 `nginx.config` 文件保存重启后却不生效时

```
sudo nginx -t
```

当出现 `ok`、`successful` 的字眼时说明配置文件语法没问题

![check-nginx-config](~@alias/img/build/check-nginx-config.jpg)
